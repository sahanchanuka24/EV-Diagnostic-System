<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EV Diagnostic Assistant (EV ‡∂ª‡∑ù‡∂ú ‡∑Ä‡∑í‡∂±‡∑í‡∑Å‡∑ä‡∂†‡∂∫ ‡∑É‡∑Ñ‡∂∫‡∂ö)</title>
    <!-- Load Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
        }
        .container {
            max-width: 900px;
        }
        .card {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        /* Custom scrollbar for better aesthetics */
        #output-area::-webkit-scrollbar {
            width: 8px;
        }
        #output-area::-webkit-scrollbar-thumb {
            background-color: #d1d5db;
            border-radius: 4px;
        }
    </style>
</head>
<body class="p-4 sm:p-8 min-h-screen">

    <div class="container mx-auto">
        <header class="text-center mb-10">
            <h1 class="text-4xl font-extrabold text-blue-700">‚ö° EV Error Management System</h1>
            <p class="text-lg text-gray-600 mt-2">‡∑Ä‡∑è‡∑Ñ‡∂±‡∂∫‡∑ö ‡∂á‡∂≠‡∑í ‡∂ú‡∑ê‡∂ß‡∑Ö‡∑î‡∑Ä ‡∑É‡∑í‡∂Ç‡∑Ñ‡∂Ω‡∑ô‡∂±‡∑ä ‡∂¥‡∑Ñ‡∂≠‡∑í‡∂±‡∑ä ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂± (AI ‡∂∏‡∂ü‡∑í‡∂±‡∑ä ‡∑Ä‡∑í‡∑Å‡∑ä‡∂Ω‡∑ö‡∑Ç‡∂´‡∂∫ ‡∂ö‡∑ô‡∂ª‡∑ö).</p>
        </header>

        <main class="grid md:grid-cols-2 gap-8">
            <!-- Input Card -->
            <div class="card bg-white p-6 rounded-xl">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">1. ‡∂ú‡∑ê‡∂ß‡∑Ö‡∑î‡∑Ä ‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª ‡∂ö‡∂ª‡∂±‡∑ä‡∂± (Describe the Issue)</h2>
                <textarea id="issue-input" rows="8" placeholder="‡∂ã‡∂Ø‡∑è: ‡∂∏‡∂ú‡∑ö EV ‡∂ë‡∂ö‡∑ö charge ‡∂ë‡∂ö ‡∂ö‡∂Ω‡∑í‡∂±‡∑ä ‡∑Ä‡∂ú‡∑ö ‡∂≠‡∑í‡∂∫‡∑ô‡∂±‡∑ä‡∂±‡∑ö ‡∂±‡∑ë, ‡∂ú‡∑ú‡∂©‡∂ö‡∑ä ‡∂â‡∂ö‡∑ä‡∂∏‡∂±‡∂ß ‡∂∂‡∑Ñ‡∑í‡∂±‡∑Ä‡∑è. Dashboard ‡∂ë‡∂ö‡∑ö ‡∂≠‡∑ê‡∂π‡∑í‡∂Ω‡∑í ‡∂¥‡∑è‡∂ß warning light ‡∂ë‡∂ö‡∂ö‡∑ä ‡∂¥‡∑ô‡∂±‡∑ä‡∂±‡∂±‡∑Ä‡∑è."
                          class="w-full p-3 border-2 border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-base"></textarea>

                <button id="diagnose-button" onclick="diagnoseError()"
                        class="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-xl transition duration-300 transform hover:scale-[1.01] focus:outline-none focus:ring-4 focus:ring-blue-300 disabled:opacity-50">
                    üîç ‡∂Ø‡∑ù‡∑Ç‡∂∫ ‡∑Ä‡∑í‡∑Å‡∑ä‡∂Ω‡∑ö‡∑Ç‡∂´‡∂∫ ‡∂ö‡∂ª‡∂±‡∑ä‡∂± (Diagnose Error)
                </button>
            </div>

            <!-- Output Card -->
            <div class="card bg-white p-6 rounded-xl">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">2. ‡∂ª‡∑ù‡∂ú ‡∑Ä‡∑í‡∂±‡∑í‡∑Å‡∑ä‡∂†‡∂∫ ‡∑É‡∑Ñ ‡∑Ä‡∑í‡∑É‡∂≥‡∑î‡∂∏‡∑ä (Diagnosis & Solutions)</h2>
                <div id="output-area" class="h-80 overflow-y-auto p-4 bg-gray-50 border border-gray-200 rounded-lg text-gray-700 whitespace-pre-wrap leading-relaxed">
                    ‡∂∏‡∑ô‡∑Ñ‡∑í AI ‡∂∏‡∂ü‡∑í‡∂±‡∑ä ‡∂Ω‡∂∂‡∑è ‡∂Ø‡∑ô‡∂± ‡∂ª‡∑ù‡∂ú ‡∑Ä‡∑í‡∂±‡∑í‡∑Å‡∑ä‡∂†‡∂∫ ‡∑É‡∑Ñ ‡∂±‡∑í‡∑Ä‡∑ê‡∂ª‡∂Ø‡∑í ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∑ö ‡∂¥‡∑í‡∂∫‡∑Ä‡∂ª ‡∂Ø‡∑í‡∑É‡∑ä ‡∑Ä‡∂±‡∑î ‡∂á‡∂≠.
                </div>
                <div id="loading-indicator" class="hidden mt-4 text-center">
                    <div class="flex items-center justify-center space-x-2">
                        <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-blue-600"></div>
                        <span class="text-blue-600 font-medium">‡∑Ä‡∑í‡∑Å‡∑ä‡∂Ω‡∑ö‡∑Ç‡∂´‡∂∫ ‡∑Ä‡∑ô‡∂∏‡∑í‡∂±‡∑ä ‡∂¥‡∑Ä‡∂≠‡∑ì... (Analyzing...)</span>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        // Firebase Setup (Mandatory in this environment, even if not used for data persistence)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the Canvas environment
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;

        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // Authentication logic
            if (initialAuthToken) {
                signInWithCustomToken(auth, initialAuthToken).catch(e => console.error("Firebase Custom Auth Failed:", e));
            } else {
                signInAnonymously(auth).catch(e => console.error("Firebase Anonymous Auth Failed:", e));
            }
        } catch (error) {
            console.error("Firebase Initialization Error:", error);
            // Non-critical: App will still function for Gemini API calls
        }
        
        // --- GEMINI API CONSTANTS AND FUNCTIONS ---
        const apiKey = ""; // API key is handled by the environment
        const model = "gemini-2.5-flash-preview-09-2025";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;

        // System Instruction: Defines the AI's role and output format (Crucial for a good response)
        const systemPrompt = `You are an expert Electric Vehicle (EV) diagnostic technician. Your user is describing a problem in Sinhala. Your task is to analyze the Sinhala input, identify the MOST LIKELY vehicle fault/error, and provide practical troubleshooting steps or recommendations.

MANDATORY OUTPUT FORMAT: You MUST structure your response into two main, clearly separated sections. Use clear Sinhala, but include the technical English term for accuracy.

1. **Diagnosis (‡∂ª‡∑ù‡∂ú ‡∑Ä‡∑í‡∂±‡∑í‡∑Å‡∑ä‡∂†‡∂∫)**: State the most likely fault.
   Example: High Voltage Battery Degradation (‡∂Ö‡∂∞‡∑í ‡∑Ä‡∑ù‡∂Ω‡∑ä‡∂ß‡∑ì‡∂∫‡∂≠‡∑è ‡∂∂‡∑ê‡∂ß‡∂ª‡∑í ‡∑Ñ‡∑è‡∂∫‡∂±‡∂∫)
   Example: 12V Battery Failure (12V ‡∂∂‡∑ê‡∂ß‡∂ª‡∑í‡∂∫ ‡∂ö‡∑ä‚Äç‡∂ª‡∑í‡∂∫‡∑è ‡∑Ä‡∑í‡∂ª‡∑Ñ‡∑í‡∂≠ ‡∑Ä‡∑ì‡∂∏)

2. **Fix/Solution (‡∂¥‡∑í‡∑Ö‡∑í‡∂∫‡∂∏‡∑ä/‡∑Ä‡∑í‡∑É‡∂≥‡∑î‡∂∏‡∑ä)**: Provide a numbered list of 3-5 practical steps the user should take. Prioritize simple checks first, then recommendations for professional service. Write these steps in clear Sinhala.
`;

        /**
         * Executes the fetch call with exponential backoff for resilience.
         * @param {Object} payload - The request body.
         * @param {number} retries - Current retry count.
         */
        async function fetchWithBackoff(payload, retries = 0) {
            const maxRetries = 5;
            const delay = Math.pow(2, retries) * 1000; // 1s, 2s, 4s, 8s, 16s

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.status === 429 && retries < maxRetries) {
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return fetchWithBackoff(payload, retries + 1);
                }

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                return response.json();

            } catch (error) {
                if (retries < maxRetries) {
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return fetchWithBackoff(payload, retries + 1);
                }
                throw new Error("API call failed after multiple retries.");
            }
        }

        /**
         * Main function to trigger the EV diagnosis.
         */
        window.diagnoseError = async function() {
            const inputElement = document.getElementById('issue-input');
            const outputElement = document.getElementById('output-area');
            const loadingIndicator = document.getElementById('loading-indicator');
            const button = document.getElementById('diagnose-button');

            const userQuery = inputElement.value.trim();

            if (userQuery.length < 10) {
                outputElement.textContent = "‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª ‡∂î‡∂∂‡∂ú‡∑ö ‡∑Ä‡∑è‡∑Ñ‡∂±‡∂∫‡∑ö ‡∂ú‡∑ê‡∂ß‡∑Ö‡∑î‡∑Ä ‡∂¥‡∑í‡∑Ö‡∑í‡∂∂‡∂≥‡∑Ä ‡∑Ä‡∑ê‡∂©‡∑í ‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂± (Please enter more details about your vehicle issue).";
                return;
            }

            // UI state management
            button.disabled = true;
            loadingIndicator.classList.remove('hidden');
            outputElement.innerHTML = '‡∑Ä‡∑í‡∑Å‡∑ä‡∂Ω‡∑ö‡∑Ç‡∂´‡∂∫ ‡∑Ä‡∑ô‡∂∏‡∑í‡∂±‡∑ä ‡∂¥‡∑Ä‡∂≠‡∑ì...';

            // Construct API payload
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
                // Google Search is not strictly necessary for general diagnostics but can be added if we want the model to check current recalls or common issues.
                // tools: [{ "google_search": {} }],
            };

            try {
                const result = await fetchWithBackoff(payload);
                const text = result?.candidates?.[0]?.content?.parts?.[0]?.text;

                if (text) {
                    // Replace markdown with HTML for better display and Sinhala line breaks
                    const formattedText = text
                        .replace(/\*\*(.*?)\*\*/g, '<strong class="text-blue-600">$1</strong>') // Bold text
                        .replace(/\n\n/g, '<br><br>') // Double newline to paragraph break
                        .replace(/\n/g, '<br>') // Single newline to line break
                        .replace(/^(#+)\s*(.*)/gm, (match, hashes, content) => { // Handle markdown headers (optional)
                            const size = 6 - hashes.length; // h2 to h6
                            return `<h${size} class="text-${30 - size*2}xl font-semibold mt-4">${content}</h${size}>`;
                        });

                    outputElement.innerHTML = formattedText;
                } else {
                    outputElement.textContent = "‡∑É‡∂∏‡∑è‡∑Ä‡∑ô‡∂±‡∑ä‡∂±, ‡∂ª‡∑ù‡∂ú ‡∑Ä‡∑í‡∂±‡∑í‡∑Å‡∑ä‡∂†‡∂∫ ‡∂Ω‡∂∂‡∑è ‡∂ú‡∑ê‡∂±‡∑ì‡∂∏‡∂ß ‡∂±‡∑ú‡∑Ñ‡∑ê‡∂ö‡∑í ‡∑Ä‡∑í‡∂∫. ‡∂±‡∑ê‡∑Ä‡∂≠ ‡∂ã‡∂≠‡∑ä‡∑É‡∑è‡∑Ñ ‡∂ö‡∂ª‡∂±‡∑ä‡∂±. (Could not retrieve diagnosis. Please try again.)";
                }

            } catch (error) {
                console.error("Gemini API Error:", error);
                outputElement.textContent = `‡∂Ø‡∑ù‡∑Ç‡∂∫‡∂ö‡∑ä ‡∑É‡∑í‡∂Ø‡∑î‡∑Ä‡∑í‡∂∫: ${error.message} (An error occurred: ${error.message})`;
            } finally {
                button.disabled = false;
                loadingIndicator.classList.add('hidden');
            }
        };
    </script>
</body>
</html>